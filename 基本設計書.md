# フリマアプリ 基本設計書

## 1. 概要
本アプリケーションは、ユーザーが商品の出品・購入・管理を行うことができるフリマアプリケーションです。
Laravel Framework + Fortify認証を使用して構築されています。

## 2. 技術スタック
- **フレームワーク**: Laravel 11
- **認証**: Laravel Fortify
- **データベース**: SQLite
- **フロントエンド**: Blade Templates + CSS
- **メール**: Mailhog (開発環境)
- **コンテナ**: Docker

## 3. 画面設計書

| 画面名称 | パス | メソッド | ルート先コントローラー | アクション | 認証必須 | 説明 |
|---------|------|----------|----------------------|------------|----------|------|
| 商品一覧画面（トップ画面） | `/` | GET | ProductController | index | 必須 | 商品一覧ページ（おすすめ表示） |
| 商品一覧画面（トップ画面）_マイリスト | `/?tab=mylist` | GET | ProductController | index | 必須 | マイリスト表示 |
| 会員登録画面 | `/register` | GET | Laravel\Fortify\RegisteredUserController | create | 不要 | 新規会員登録 |
| 会員登録処理 | `/register` | POST | Laravel\Fortify\RegisteredUserController | store | 不要 | 会員登録実行 |
| ログイン画面 | `/login` | GET | Auth\LoginController | showLoginForm | 不要 | ログイン画面 |
| ログイン処理 | `/login` | POST | Auth\LoginController | login | 不要 | ログイン実行 |
| ログアウト処理 | `/logout` | POST | Auth\LoginController | logout | 必須 | ログアウト実行 |
| 商品詳細画面 | `/item/{product}` | GET | ProductController | show | 必須 | 商品詳細表示 |
| 商品購入画面 | `/purchase/{product}` | GET | PurchaseController | create | 必須 | 商品購入手続き |
| 商品購入処理 | `/purchase/{product}` | POST | PurchaseController | store | 必須 | 購入実行 |
| 住所変更ページ | `/purchase/address/{product}` | GET | PurchaseController | editAddress | 必須 | 配送先住所変更 |
| 住所変更処理 | `/purchase/address/{product}` | PUT | PurchaseController | updateAddress | 必須 | 住所変更実行 |
| 商品出品画面 | `/sell` | GET | ProductController | create | 必須 | 商品出品フォーム |
| 商品出品処理 | `/products` | POST | ProductController | store | 必須 | 商品出品実行 |
| 商品編集画面 | `/products/{product}/edit` | GET | ProductController | edit | 必須 | 商品編集フォーム |
| 商品更新処理 | `/products/{product}` | PUT | ProductController | update | 必須 | 商品更新実行 |
| 商品削除処理 | `/products/{product}` | DELETE | ProductController | destroy | 必須 | 商品削除実行 |
| プロフィール画面 | `/mypage` | GET | ProfileController | show | 必須 | プロフィール表示 |
| プロフィール編集画面 | `/mypage/profile` | GET | ProfileController | edit | 必須 | プロフィール編集フォーム |
| プロフィール更新処理 | `/profile` | PUT | ProfileController | update | 必須 | プロフィール更新実行 |
| プロフィール画面_購入した商品一覧 | `/mypage?page=buy` | GET | ProfileController | show | 必須 | 購入商品一覧表示 |
| プロフィール画面_出品した商品一覧 | `/mypage?page=sell` | GET | ProfileController | show | 必須 | 出品商品一覧表示 |
| コメント投稿処理 | `/comments` | POST | CommentController | store | 必須 | 商品コメント投稿 |
| いいね追加処理 | `/favorites/{product}` | POST | FavoriteController | store | 必須 | いいね追加 |
| いいね削除処理 | `/favorites/{product}` | DELETE | FavoriteController | destroy | 必須 | いいね削除 |
| メール認証通知画面 | `/email/verify` | GET | - | - | 必須 | メール認証未完了時の通知 |
| メール認証処理 | `/email/verify/{id}/{hash}` | GET | - | - | 必須 | メール認証実行 |
| メール再送信処理 | `/email/verification-notification` | POST | - | - | 必須 | 認証メール再送信 |
| プロフィール設定画面 | `/profile/setup` | GET | ProfileSetupController | show | 必須 | 初回ログイン時のプロフィール設定 |
| プロフィール設定処理 | `/profile/setup` | POST | ProfileSetupController | store | 必須 | プロフィール設定実行 |
| ダッシュボード | `/dashboard` | GET | DashboardController | index | 必須 | ダッシュボード表示 |

## 4. 認証・認可

### 4.1 認証方式
- **Laravel Fortify** を使用したセッション認証
- **メール認証** 必須（新規登録時・初回ログイン時）
- **二要素認証** 対応（オプション）

### 4.2 認証フロー
1. **新規登録**: 会員登録 → メール認証 → プロフィール設定 → トップ画面
2. **ログイン**: ログイン → メール認証確認 → トップ画面
3. **初回ログイン**: ログイン → メール認証 → プロフィール設定 → トップ画面

### 4.3 ミドルウェア
- **`auth`**: ログイン必須
- **`verified`**: メール認証完了必須
- **`check.first.login`**: 初回ログイン時のプロフィール設定完了必須

## 5. データベース設計

### 5.1 主要テーブル
- **users**: ユーザー情報
- **products**: 商品情報
- **categories**: カテゴリ情報
- **product_categories**: 商品-カテゴリ関連（多対多）
- **comments**: 商品コメント
- **purchases**: 購入履歴
- **favorites**: いいね情報

### 5.2 主要リレーション
- User → Products (1対多)
- Product → Categories (多対多)
- User → Comments (1対多)
- Product → Comments (1対多)
- User → Purchases (1対多)
- Product → Purchases (1対多)
- User → Favorites (1対多)
- Product → Favorites (1対多)

## 6. ファイル構成

### 6.1 コントローラー
```
app/Http/Controllers/
├── Auth/
│   └── LoginController.php          # ログイン処理
├── AuthController.php               # 認証関連（未使用）
├── CommentController.php            # コメント管理
├── DashboardController.php          # ダッシュボード
├── FavoriteController.php           # いいね管理
├── ProductController.php            # 商品管理
├── ProfileController.php            # プロフィール管理
├── ProfileSetupController.php       # 初回プロフィール設定
└── PurchaseController.php           # 購入管理
```

### 6.2 モデル
```
app/Models/
├── Category.php                     # カテゴリモデル
├── Comment.php                      # コメントモデル
├── Favorite.php                     # いいねモデル
├── Product.php                      # 商品モデル
├── Purchase.php                     # 購入モデル
└── User.php                         # ユーザーモデル
```

### 6.3 ビュー
```
resources/views/
├── auth/                           # 認証関連
│   ├── email-verification-notice.blade.php
│   ├── login.blade.php
│   └── verify-email.blade.php
├── emails/                         # メールテンプレート
│   └── verify-email.blade.php
├── layouts/
│   └── app.blade.php               # メインレイアウト
├── products/                       # 商品関連
│   ├── create.blade.php
│   ├── edit.blade.php
│   ├── index.blade.php
│   └── show.blade.php
├── profile/                        # プロフィール関連
│   ├── edit.blade.php
│   ├── setup.blade.php
│   └── show.blade.php
├── purchases/                      # 購入関連
│   ├── create.blade.php
│   └── edit_address.blade.php
├── dashboard.blade.php
└── welcome.blade.php
```

## 7. 主要機能

### 7.1 商品管理
- 商品一覧表示（おすすめ・マイリスト切り替え）
- 商品詳細表示
- 商品出品・編集・削除
- カテゴリ管理（多対多リレーション）
- 画像アップロード

### 7.2 ユーザー管理
- 会員登録・ログイン・ログアウト
- メール認証
- プロフィール管理
- プロフィール画像アップロード

### 7.3 購入管理
- 商品購入手続き
- 配送先住所管理
- 購入履歴表示

### 7.4 コミュニケーション
- 商品コメント機能
- いいね機能

## 8. セキュリティ

### 8.1 認証・認可
- メール認証必須
- セッション管理
- CSRF保護
- レート制限

### 8.2 データ保護
- 入力値検証
- SQLインジェクション対策
- XSS対策
- ファイルアップロード制限

## 9. 開発環境

### 9.1 必要環境
- PHP 8.2+
- Composer
- Node.js
- Docker (オプション)

### 9.2 セットアップ
```bash
# 依存関係インストール
composer install
npm install

# 環境設定
cp .env.example .env
php artisan key:generate

# データベース設定
php artisan migrate
php artisan db:seed

# ストレージリンク
php artisan storage:link

# 開発サーバー起動
php artisan serve
```

### 9.3 Docker環境
```bash
# Docker Compose起動
docker-compose up -d

# Mailhog起動（メールテスト用）
docker-compose up mailhog
```

## 10. デプロイ

### 10.1 本番環境設定
- 環境変数の設定
- データベース設定
- ストレージ設定
- メール設定

### 10.2 パフォーマンス最適化
- キャッシュ設定
- 画像最適化
- データベースインデックス
- クエリ最適化

---

**作成日**: 2025年1月28日
**バージョン**: 1.0
**作成者**: 開発チーム
